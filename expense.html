

<!DOCTYPE html>
<html lang="en">
<body>
    <form onsubmit="saveToStorage(event)" method="POST">
        <label >Choose Expense Amount</label>
        <input type="text" id="ea" name="eamount" required>
        <label >Choose description</label>
        <input type="text" id="ed" name="edescription" required>
        <label >Choose a categoty</label>
        <input list="category" id="cl" name="category">
        <datalist id="category">
            <option value="fuel"></option>
            <option value="Movie"></option>
            <option value="salary"></option>
            <option value="food"></option>
        </datalist>
        <button>Add Expense</button>

    </form>
    <ul id='listOfExpenses'></ul>

    <button onclick="payment(event)">Buy Premium</button>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.1.2/axios.min.js"  ></script>
    <!--Provides a code for doing netwrok calls-->

    <script>
        function saveToStorage(event)
        {
            event.preventDefault();
            const eamount = event.target.eamount.value;
            const edescription = event.target.edescription.value;
            const category = event.target.category.value;
            const token = localStorage.getItem('token');
            
            const obj = {
                eamount,
                edescription,
                category,
                
            }

            
                axios.post("http://localhost:5000/user/addExpense",obj, {headers: {"Authorization": token}}).then((response)=>{
                    console.log(response);
                    
                    showListofRegisteredExpenses(response.data.newExpenseDetail)

                }).catch((err)=>{
                console.log(err);
            })
                
            //clear inout fields
            document.getElementById('ed').value = ''; 
            document.getElementById('ea').value = '';
            document.getElementById('cl').value = '';


        }

        function showListofRegisteredExpenses(user)
        {
            const parentNode = document.getElementById('listOfExpenses'); 
            const createNewUserHtml = `<li id=${user.id}>${user.eamount} - ${user.edescription} -${user.category} 
                                            <button onclick="deleteUser('${user.id}')">Delete</button>
                                            <button onclick="editUser('${user.id}','${user.edescription}','${user.eamount}','${user.category}')">Edit</button>
                                           
                                         </li>
                                        `
  

            parentNode.innerHTML += createNewUserHtml;

            document.getElementById('ed').value = ''; 
            document.getElementById('ea').value = '';
            document.getElementById('cl').value = '';
        
        }








        window.addEventListener('DOMContentLoaded', (event) =>{
            const token = localStorage.getItem('token');
            
            
                axios.get("http://localhost:5000/user/getExpenses", {headers: {"Authorization": token}}).then((response)=>{
                    console.log(response.data.data[0]);
                    for(let i=0;i<response.data.data.length;i++)
                    {
                        
                        showListofRegisteredExpenses(response.data.data[i]);
                    }
                    }).catch((err)=> console.log(err));          
            })
            
                
            
        

        

        function deleteUser(userId)
            {
                const token = localStorage.getItem('token');

                axios.delete(`http://localhost:5000/user/deleteExpense/${userId}`,{headers: {"Authorization": token}}).then((response)=>{
                    removeItemFromScreen(userId);
                }).catch((err)=>{
                    console.log(err);
                })
            }


            function editUser(userId,expenseDescription,expenseAmount,expenseCategory)
        {
            document.getElementById('ed').value = expenseDescription; 
            document.getElementById('ea').value = expenseAmount;
            document.getElementById('cl').value = expenseCategory;

            deleteUser(userId);

        }

        

        function removeItemFromScreen(userId)
        {
            
            const parentNode = document.getElementById('listOfExpenses');
            const elem = document.getElementById(userId)

            parentNode.removeChild(elem);

        }

         async function payment(e) {
            const token = localStorage.getItem('token');
            const response  = await axios.get('http://localhost:5000/purchase/premiummembership', { headers: {"Authorization" : token} });
            console.log(response);
            var options =
            {
            "key": response.data.key_id, // Enter the Key ID generated from the Dashboard
            "name": "Test Company",
            "order_id": response.data.order.id, // For one time payment
            "prefill": {
            "name": "Test User",
            "email": "test.user@example.com",
            "contact": "7003442036"
            },
            "theme": {
            "color": "#3399cc"
            },
            // This handler function will handle the success payment
            "handler": function (response) {
                console.log(response);
                axios.post('http://localhost:5000/purchase/updatetransactionstatus',{
                    order_id: options.order_id,
                    payment_id: response.razorpay_payment_id,
                }, { headers: {"Authorization" : token} }).then(() => {
                    alert('You are a Premium User Now')
                }).catch(() => {
                    alert('Something went wrong. Try Again!!!')
                })
            },
        };
        const rzp1 = new Razorpay(options);
        rzp1.open();
        e.preventDefault();

        rzp1.on('payment.failed', function (response){
        alert(response.error.code);
        alert(response.error.description);
        alert(response.error.source);
        alert(response.error.step);
        alert(response.error.reason);
        alert(response.error.metadata.order_id);
        alert(response.error.metadata.payment_id);
        });
        }

/*
            axios.delete(`https://crudcrud.com/api/e339815307da439c8403a76d86a2ee32/expenseData/${userId}`)
            .then((response)=>{
                removeItemFromScreen(userId)

            }).catch((err)=>{
                console.log(err);
            })
            
            //localStorage.removeItem(expenseDescription);
            //removeItemFromScreen(expenseDescription);
            */
      

         
       

        
        



    </script>
    
</body>
</html>